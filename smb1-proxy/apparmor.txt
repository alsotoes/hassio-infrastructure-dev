# AppArmor profile for SMB1 Proxy add-on
# Currently disabled in config.yaml due to s6-overlay compatibility issues
# Can be re-enabled in future versions after further testing

#include <tunables/global>

profile smb1_proxy flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/base>
  #include <abstractions/nameservice>

  # Capabilities
  capability sys_admin,
  capability setuid,
  capability setgid,
  capability dac_override,
  capability chown,
  capability fowner,
  capability fsetid,
  capability net_bind_service,
  capability kill,
  capability sys_ptrace,

  # Network access
  network inet dgram,
  network inet stream,
  network inet6 dgram,
  network inet6 stream,

  # Init system and core executables
  /init rix,
  /usr/bin/s6-* rix,
  /bin/s6-* rix,
  /usr/bin/s6-overlay-* rix,
  /bin/s6-overlay-* rix,
  /command/s6-* rix,
  /package/admin/s6-overlay/command/* rix,
  /usr/bin/with-contenv rix,
  /usr/bin/bashio rix,
  /usr/bin/bashio.* rix,

  # File system access
  /usr/bin/smbnetfs rix,
  /usr/sbin/smbd rix,
  /usr/sbin/nmbd rix,
  /usr/bin/smbclient rix,
  /usr/bin/jq rix,
  /bin/bash rix,
  /bin/sh rix,
  /usr/bin/tail rix,
  /usr/bin/mkdir rix,
  /usr/bin/ln rix,
  /usr/bin/rm rix,
  /usr/bin/cat rix,
  /usr/bin/chmod rix,
  /usr/bin/chown rix,
  /usr/sbin/useradd rix,
  /usr/bin/pdbedit rix,
  /usr/bin/smbpasswd rix,
  /usr/bin/getent rix,
  /usr/bin/awk rix,
  /usr/bin/tr rix,
  /usr/bin/xargs rix,
  /usr/bin/hostname rix,
  /usr/bin/id rix,
  /usr/bin/grep rix,
  /usr/bin/echo rix,
  /usr/bin/sleep rix,
  /usr/bin/ls rix,
  /usr/bin/mountpoint rix,
  /usr/bin/pgrep rix,
  /usr/bin/pkill rix,
  /usr/bin/timeout rix,
  /usr/bin/fusermount rix,
  /usr/bin/nc rix,
  /usr/bin/date rix,
  /usr/bin/read rix,
  /usr/bin/test rix,
  /usr/bin/[ rix,
  /usr/bin/expr rix,
  /usr/bin/cut rix,
  /usr/bin/sort rix,
  /usr/bin/uniq rix,
  /usr/bin/head rix,
  /usr/bin/wc rix,
  /bin/mount rix,
  /bin/umount rix,
  /usr/local/bin/health-check rix,
  /usr/local/bin/status-server rix,

  # FUSE access
  /dev/fuse rw,
  /sys/fs/fuse/connections/ r,
  /sys/fs/fuse/connections/** r,

  # Configuration and data directories
  /data/ rw,
  /data/** rw,
  /share/ rw,
  /share/** rw,
  /etc/samba/ rw,
  /etc/samba/** rw,
  /root/.smb/ rw,
  /root/.smb/** rw,
  /run/samba/ rw,
  /run/samba/** rw,
  /var/lib/samba/ rw,
  /var/lib/samba/** rw,
  /var/cache/samba/ rw,
  /var/cache/samba/** rw,
  /tmp/ rw,
  /tmp/** rw,

  # Service directories
  /etc/cont-init.d/ r,
  /etc/cont-init.d/** rix,
  /etc/services.d/ r,
  /etc/services.d/** rix,

  # System files
  /etc/passwd r,
  /etc/group r,
  /etc/shadow r,
  /etc/gshadow r,
  /etc/hosts r,
  /etc/nsswitch.conf r,
  /etc/resolv.conf r,
  /etc/services r,
  /etc/protocols r,
  /proc/sys/net/ipv4/ip_forward w,
  /proc/filesystems r,
  /proc/mounts r,
  /proc/*/mounts r,
  /proc/*/mountinfo r,
  /proc/*/stat r,
  /proc/*/cmdline r,
  /proc/*/comm r,
  /proc/*/exe r,
  /proc/loadavg r,
  /proc/meminfo r,
  /proc/uptime r,
  /sys/class/net/ r,
  /sys/class/net/** r,

  # D-Bus and Avahi
  /usr/bin/dbus-daemon rix,
  /usr/sbin/avahi-daemon rix,
  /var/run/dbus/ rw,
  /var/run/dbus/** rw,
  /var/run/avahi-daemon/ rw,
  /var/run/avahi-daemon/** rw,

  # Logging
  /dev/stdout w,
  /dev/stderr w,
  /dev/null rw,

  # Bashio access
  /opt/bashio/ r,
  /opt/bashio/** r,
  
  # Library access
  /lib/** r,
  /usr/lib/** r,
  /lib64/** r,
  
  # Additional system paths
  /run/ rw,
  /run/** rw,
}
